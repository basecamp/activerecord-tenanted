#!/usr/bin/env bash
set -e

MYSQL_CONTAINER_NAME="${MYSQL_CONTAINER_NAME:-activerecord-tenanted-mysql}"
MYSQL_IMAGE="mysql:latest"
MYSQL_ROOT_PASSWORD="devcontainer"
MYSQL_PORT="${MYSQL_PORT:-3307}"

POSTGRES_CONTAINER_NAME="${POSTGRES_CONTAINER_NAME:-activerecord-tenanted-postgres}"
POSTGRES_IMAGE="postgres:latest"
POSTGRES_PASSWORD="postgres"
POSTGRES_PORT="${POSTGRES_PORT:-5432}"

echo "==> Checking Docker installation..."
if ! command -v docker &> /dev/null; then
  echo "ERROR: Docker is not installed. Please install Docker and try again."
  exit 1
fi

if ! docker info &> /dev/null; then
  echo "ERROR: Docker daemon is not running. Please start Docker and try again."
  exit 1
fi

echo "==> Setting up MySQL container..."
if docker ps -a --format '{{.Names}}' | grep -q "^${MYSQL_CONTAINER_NAME}$"; then
  echo "    Stopping and removing existing container..."
  docker stop "$MYSQL_CONTAINER_NAME" > /dev/null 2>&1 || true
  docker rm "$MYSQL_CONTAINER_NAME" > /dev/null 2>&1 || true
fi

echo "==> Creating and starting MySQL container..."
docker run -d \
  --name="$MYSQL_CONTAINER_NAME" \
  --restart unless-stopped \
  -p "127.0.0.1:${MYSQL_PORT}:3306" \
  -e MYSQL_ROOT_PASSWORD="$MYSQL_ROOT_PASSWORD" \
  "$MYSQL_IMAGE"

echo "==> Waiting for MySQL to be ready..."
MAX_TRIES=30
TRIES=0
while [ $TRIES -lt $MAX_TRIES ]; do
  if docker exec "$MYSQL_CONTAINER_NAME" mysqladmin ping -h localhost --silent &> /dev/null; then
    echo "    MySQL is ready!"
    break
  fi
  TRIES=$((TRIES + 1))
  if [ $TRIES -eq $MAX_TRIES ]; then
    echo "ERROR: MySQL failed to start within expected time"
    exit 1
  fi
  echo -n "."
  sleep 2
done

echo "==> Verifying MySQL database connection..."
docker exec "$MYSQL_CONTAINER_NAME" mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "SELECT 1;" > /dev/null 2>&1
echo "    MySQL database ready!"

echo "==> Setting up PostgreSQL container..."
if docker ps -a --format '{{.Names}}' | grep -q "^${POSTGRES_CONTAINER_NAME}$"; then
  echo "    Stopping and removing existing container..."
  docker stop "$POSTGRES_CONTAINER_NAME" > /dev/null 2>&1 || true
  docker rm "$POSTGRES_CONTAINER_NAME" > /dev/null 2>&1 || true
fi

echo "==> Creating and starting PostgreSQL container..."
docker run -d \
  --name="$POSTGRES_CONTAINER_NAME" \
  --restart unless-stopped \
  -p "127.0.0.1:${POSTGRES_PORT}:5432" \
  -e POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
  "$POSTGRES_IMAGE"

echo "==> Waiting for PostgreSQL to be ready..."
TRIES=0
while [ $TRIES -lt $MAX_TRIES ]; do
  if docker exec "$POSTGRES_CONTAINER_NAME" pg_isready -U postgres &> /dev/null; then
    echo "    PostgreSQL is ready!"
    break
  fi
  TRIES=$((TRIES + 1))
  if [ $TRIES -eq $MAX_TRIES ]; then
    echo "ERROR: PostgreSQL failed to start within expected time"
    exit 1
  fi
  echo -n "."
  sleep 2
done

echo "==> Verifying PostgreSQL database connection..."
docker exec "$POSTGRES_CONTAINER_NAME" psql -U postgres -c "SELECT 1;" > /dev/null 2>&1
echo "    PostgreSQL database ready!"

echo "==> Running bundle install..."
bundle check > /dev/null 2>&1 || bundle install

echo ""
echo "==> Setup complete!"
echo ""
echo "MySQL is running on 127.0.0.1:${MYSQL_PORT}"
echo "PostgreSQL is running on 127.0.0.1:${POSTGRES_PORT}"
echo ""
echo "Connection details:"
echo "  MySQL:      mysql -h 127.0.0.1 -P ${MYSQL_PORT} -u root -p${MYSQL_ROOT_PASSWORD}"
echo "  PostgreSQL: psql -h 127.0.0.1 -p ${POSTGRES_PORT} -U postgres"
echo ""
