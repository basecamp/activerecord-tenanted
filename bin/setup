#!/usr/bin/env bash
set -e

CONTAINER_NAME="${CONTAINER_NAME:-activerecord-tenanted-mysql}"
MYSQL_IMAGE="mysql:latest"
MYSQL_ROOT_PASSWORD="devcontainer"
MYSQL_PORT="${MYSQL_PORT:-3307}"

echo "==> Checking Docker installation..."
if ! command -v docker &> /dev/null; then
  echo "ERROR: Docker is not installed. Please install Docker and try again."
  exit 1
fi

if ! docker info &> /dev/null; then
  echo "ERROR: Docker daemon is not running. Please start Docker and try again."
  exit 1
fi

echo "==> Setting up MySQL container..."
if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
  echo "    Stopping and removing existing container..."
  docker stop "$CONTAINER_NAME" > /dev/null 2>&1 || true
  docker rm "$CONTAINER_NAME" > /dev/null 2>&1 || true
fi

echo "==> Creating and starting MySQL container..."
docker run -d \
  --name="$CONTAINER_NAME" \
  --restart unless-stopped \
  -p "127.0.0.1:${MYSQL_PORT}:3306" \
  -e MYSQL_ROOT_PASSWORD="$MYSQL_ROOT_PASSWORD" \
  "$MYSQL_IMAGE"

echo "==> Waiting for MySQL to be ready..."
MAX_TRIES=30
TRIES=0
while [ $TRIES -lt $MAX_TRIES ]; do
  if docker exec "$CONTAINER_NAME" mysqladmin ping -h localhost --silent &> /dev/null; then
    echo "    MySQL is ready!"
    break
  fi
  TRIES=$((TRIES + 1))
  if [ $TRIES -eq $MAX_TRIES ]; then
    echo "ERROR: MySQL failed to start within expected time"
    exit 1
  fi
  echo -n "."
  sleep 2
done

echo "==> Verifying database connection..."
docker exec "$CONTAINER_NAME" mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "SELECT 1;" > /dev/null 2>&1
echo "    Database ready!"

echo "==> Running bundle install..."
bundle check > /dev/null 2>&1 || bundle install

echo ""
echo "==> Setup complete!"
echo ""
echo "MySQL is running on 127.0.0.1:${MYSQL_PORT}"
echo ""
